<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juara Tandas Amir - Pengesan Latihan</title>
    <!-- Muat turun Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Muat turun fon Urbanist dari Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Tetapkan fon Urbanist dan latar belakang */
        body {
            font-family: 'Urbanist', sans-serif;
            background-color: #F5F5F6; /* Warna latar belakang lembut dari palet */
            color: #272831; /* Warna teks utama */
            padding: 1rem;
        }

        /* Warna Palet Disesuaikan */
        .color-primary-yellow { background-color: #FED415; }
        .color-success-green { background-color: #5FC756; }
        .color-attempt-orange { background-color: #FDA014; }
        .color-failure-red { background-color: #E14535; }
        .color-dark-text { color: #272831; }

        /* Gaya sel grid untuk keseronokan */
        .grid-cell {
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .grid-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Untuk grid: */
        .grid-cell.code-2 { background-color: #d1fae5; color: #5FC756; }
        .grid-cell.code-1 { background-color: #fff9e6; color: #FDA014; }
        .grid-cell.code-0 { background-color: #fee2e2; color: #E14535; }
        .grid-cell.code-empty { background-color: white; }

        /* Icon di dalam grid */
        .grid-cell.code-2 span, .grid-cell.code-1 span, .grid-cell.code-0 span {
            color: inherit; /* Warisi warna sel */
        }
        
        /* Gaya untuk cetakan: Sembunyikan semua elemen interaktif semasa mencetak */
        @media print {
            body {
                background-color: white !important;
                padding: 0;
            }
            /* Sembunyikan butang dan modal */
            #edit-settings-btn, .color-primary-yellow, .flex-wrap, #user-id-display, .hidden.flex, #edit-modal, #settings-modal, #message-modal {
                display: none !important;
            }
            /* Kekalkan grid kelihatan baik */
            #data-grid {
                overflow: visible !important;
                min-width: 100% !important;
            }
        }
    </style>
</head>
<body>

    <div class="max-w-7xl mx-auto">
        <!-- HEADER: Cerita Utama Aplikasi -->
        <header class="color-primary-yellow p-6 rounded-3xl shadow-lg mb-8 border-4 border-[#272831] relative">
            <h1 class="text-4xl md:text-5xl font-extrabold color-dark-text flex items-center">
                <span id="student-name-display">AMIR</span>: JUARA TANDAS! üèÜ
                <!-- Butang Edit Tetapan -->
                <button id="edit-settings-btn" class="ml-4 p-2 bg-white rounded-full shadow-md hover:bg-gray-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 color-dark-text" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.637 5.637l-6.364 6.364V17h2.414l6.364-6.364-2.828-2.828z" />
                    </svg>
                </button>
            </h1>
            <p class="text-xl mt-2 font-medium color-dark-text">
                <span id="school-location-display">Lokasi Sekolah Pelatih Contoh</span>
            </p>
            <!-- Kawalan Navigasi Bulan/Tarikh -->
            <div class="mt-4 flex items-center justify-between bg-white/70 p-2 rounded-xl">
                <button id="prev-month-btn" class="p-2 bg-gray-300 rounded-lg hover:bg-gray-400 transition color-dark-text font-bold text-sm sm:text-base">
                    &lt; BULAN LEPAS
                </button>
                <p class="text-lg sm:text-xl font-extrabold color-dark-text" id="current-month-display">
                    Tarikh: 1hb November 2025 - 30 November 2025
                </p>
                <button id="next-month-btn" class="p-2 bg-gray-300 rounded-lg hover:bg-gray-400 transition color-dark-text font-bold text-sm sm:text-base">
                    BULAN DEPAN &gt;
                </button>
            </div>
        </header>

        <!-- KAD UTAMA & STATISTIK -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            <!-- Kad Legenda / Kod -->
            <div class="lg:col-span-1 p-6 bg-white rounded-2xl shadow-xl border-t-8 border-b-8 border-gray-200">
                <h2 class="text-2xl font-bold mb-3 color-dark-text">Kod Pengumpulan Data:</h2>
                <ul class="space-y-3 font-semibold text-lg">
                    <li class="flex items-center">
                        <span class="mr-3 text-2xl" style="color:#5FC756;">‚≠ê</span>
                        <span class="text-[#5FC756]">2</span> = Kencing/Berak di Tandas (Juara!)
                    </li>
                    <li class="flex items-center">
                        <span class="mr-3 text-2xl" style="color:#FDA014;">ü§î</span>
                        <span class="text-[#FDA014]">1</span> = Pergi Tandas Tapi Tidak Berjaya (Cuba Lagi!)
                    </li>
                    <li class="flex items-center">
                        <span class="mr-3 text-2xl" style="color:#E14535;">üíß</span>
                        <span class="text-[#E14535]">0</span> = Kencing/Berak di Luar (Terlupa)
                    </li>
                </ul>
                <p class="mt-4 text-sm text-gray-500">
                    <span id="user-id-display" class="font-mono text-xs break-all"></span>
                </p>
            </div>

            <!-- Kad Peratusan Kejayaan -->
            <div class="lg:col-span-3 p-6 bg-white rounded-2xl shadow-xl border-t-8 border-b-8 border-gray-200">
                <h2 class="text-2xl font-bold mb-3 color-dark-text">Statistik Kejayaan (<span id="stats-month-year"></span>):</h2>
                <div class="flex items-center space-x-4">
                    <div class="text-6xl font-extrabold" id="success-percentage">0%</div>
                    <div class="flex-1">
                        <p class="text-xl font-semibold mb-2">Peratus kencing di tandas (%)</p>
                        <div class="w-full bg-[#EFEFF0] rounded-full h-4">
                            <div id="progress-bar" class="h-4 rounded-full color-success-green transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <p class="mt-4 text-sm text-gray-500">Jumlah Kejayaan: <span id="total-success" class="font-bold">0</span> / <span id="total-attempts" class="font-bold">0</span></p>
            </div>
        </div>

        <!-- GRID UTAMA PENGUMPULAN DATA -->
        <div class="bg-white p-4 rounded-2xl shadow-xl overflow-x-auto">
            <h2 class="text-2xl font-bold mb-4 color-dark-text">Jadual Pengesanan:</h2>
            <div id="data-grid" class="min-w-full">
                <!-- Grid akan dihasilkan oleh JavaScript di sini -->
            </div>
        </div>
        
        <!-- BAHAGIAN BUTANG TINDAKAN -->
        <div class="flex flex-wrap justify-center space-x-4 mt-8">
            <!-- Input fail tersembunyi untuk Import Data -->
            <input type="file" id="import-file-input" class="hidden" accept="application/json"> 
            
            <button id="import-data-btn" class="p-3 my-2 font-bold rounded-full bg-gray-300 hover:bg-gray-400 transition color-dark-text">IMPORT DATA</button>
            <button id="export-data-btn" class="p-3 my-2 font-bold rounded-full bg-gray-300 hover:bg-gray-400 transition color-dark-text">EXPORT DATA</button>
            <button id="print-btn" class="p-3 my-2 font-bold rounded-full bg-gray-300 hover:bg-gray-400 transition color-dark-text">PRINT</button>
            <button id="download-pdf-btn" class="p-3 my-2 font-bold rounded-full color-attempt-orange hover:bg-[#ffb028] transition color-dark-text">DOWNLOAD (PDF)</button>
            <button id="reset-data-btn" class="p-3 my-2 font-bold rounded-full bg-red-500 hover:bg-red-600 transition text-white">SET SEMULA DATA BULAN INI</button>
        </div>
        <p class="text-sm text-center text-gray-500 mt-4">Nota: Data disimpan secara automatik dalam Firestore. Gunakan import/export untuk sandaran.</p>
    </div>

    <!-- MODAL POPUP (Mesej Status Ringkas) -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 color-dark-text"></h3>
            <p id="modal-message" class="mb-6"></p>
            <button onclick="document.getElementById('message-modal').classList.add('hidden');" class="p-2 w-full font-bold rounded-lg color-primary-yellow hover:opacity-80 color-dark-text">OK</button>
        </div>
    </div>
    
    <!-- MODAL EDIT DATA (Pengumpulan Data) -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center border-t-8 color-primary-yellow">
            <h3 class="text-2xl font-bold mb-2 color-dark-text">Kemaskini Data</h3>
            <p id="edit-modal-context" class="mb-4 text-sm text-gray-600"></p>
            
            <div class="space-y-3 mb-6">
                <!-- Pilihan Kod 2 (Juara!) -->
                <button data-code="2" class="code-btn w-full p-3 font-bold rounded-lg bg-green-500 hover:bg-green-600 transition text-white flex items-center justify-center">
                    <span class="mr-3 text-2xl">‚≠ê</span> Kod 2 (Juara!)
                </button>
                
                <!-- Pilihan Kod 1 (Cuba Lagi!) -->
                <button data-code="1" class="code-btn w-full p-3 font-bold rounded-lg bg-yellow-500 hover:bg-yellow-600 transition text-white flex items-center justify-center">
                    <span class="mr-3 text-2xl">ü§î</span> Kod 1 (Cuba Lagi!)
                </button>
                
                <!-- Pilihan Kod 0 (Terlupa) -->
                <button data-code="0" class="code-btn w-full p-3 font-bold rounded-lg bg-red-500 hover:bg-red-600 transition text-white flex items-center justify-center">
                    <span class="mr-3 text-2xl">üíß</span> Kod 0 (Terlupa)
                </button>
            </div>
            
            <div class="flex space-x-3">
                <button id="remove-data-btn" class="flex-1 p-2 font-bold rounded-lg bg-gray-400 hover:bg-gray-500 transition text-white">
                    BUANG DATA
                </button>
                <button id="cancel-edit-btn" class="flex-1 p-2 font-bold rounded-lg bg-gray-200 hover:bg-gray-300 transition color-dark-text">
                    BATAL
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL TETAPAN (Nama dan Lokasi Sekolah) -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full border-t-8 border-blue-500">
            <h3 class="text-2xl font-bold mb-6 color-dark-text">Tetapan Aplikasi</h3>
            <div class="space-y-4">
                <div>
                    <label for="setting-student-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Pelajar:</label>
                    <input type="text" id="setting-student-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: AMIR">
                </div>
                <div>
                    <label for="setting-school-location" class="block text-sm font-medium text-gray-700 mb-1">Lokasi Sekolah Pelatih:</label>
                    <input type="text" id="setting-school-location" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: SK Taman Indah">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-settings-btn" class="p-3 font-bold rounded-lg bg-gray-200 hover:bg-gray-300 transition color-dark-text">
                    BATAL
                </button>
                <button id="save-settings-btn" class="p-3 font-bold rounded-lg bg-blue-500 hover:bg-blue-600 transition text-white">
                    SIMPAN
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import Firebase SDKs. Pastikan semua yang diperlukan diimport di sini.
        import { initializeApp as fbInitializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"; 
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Tetapan Global Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Data Global
        const TIME_SLOTS = [
            '1:00 AM', '2:00 AM', '3:00 AM', '4:00 AM', '5:00 AM', '6:00 AM', 
            '7:00 AM', '8:00 AM', '9:00 AM', '10:00 AM', '11:00 AM', '12:00 PM'
        ];
        
        // Firebase Instances
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Data Aplikasi
        let trackerData = {}; // Data pengesan semasa (bulan ini)
        let appConfig = {
            studentName: "AMIR",
            schoolLocation: "Lokasi Sekolah Pelatih Contoh"
        };
        let currentMonthDate = new Date(); // Objek tarikh untuk menjejaki bulan/tahun semasa

        // --------------------------------------------------------
        // FIREBASE & AUTHENTICATION
        // --------------------------------------------------------

        async function initFirebase() {
            try {
                // setLogLevel('debug'); // Buka komen untuk debugging
                app = fbInitializeApp(firebaseConfig); 
                db = getFirestore(app);
                auth = getAuth(app);

                // Autentikasi pengguna
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id-display').textContent = `User ID (Simpanan Data): ${userId}`;
                        loadAppConfig();
                        setupMonthlyDataListener();
                    } else {
                        if (initialAuthToken) {
                            console.warn("Autentikasi token custom gagal, mencuba secara anonim...");
                        }
                        signInAnonymously(auth).then(() => {
                        }).catch((error) => {
                             console.error("Gagal log masuk secara anonim:", error);
                             userId = null;
                             isAuthReady = true;
                             document.getElementById('user-id-display').textContent = `Gagal log masuk.`;
                             showMessageModal("Ralat Log Masuk", "Gagal log masuk. Sila cuba lagi.");
                        });
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(error => {
                        console.warn("signInWithCustomToken gagal:", error);
                    });
                }
                
            } catch (error) {
                console.error("Ralat permulaan Firebase:", error);
                showMessageModal("Ralat Firebase", "Gagal memulakan perkhidmatan Firebase. Semak konsol untuk butiran.");
            }
        }

        // --------------------------------------------------------
        // DATA PATHS & FIREBASE OPERATIONS
        // --------------------------------------------------------

        function getUserConfigDocRef() {
            if (!userId) return null;
            // Path: /artifacts/{appId}/users/{userId}/settings/config
            return doc(db, `artifacts/${appId}/users/${userId}/settings/config`);
        }
        
        function getMonthlyDataDocRef(date) {
            if (!userId) return null;
            // Format YYYY-MM
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const monthYearKey = `${year}-${month}`;
            // Path: /artifacts/{appId}/users/{userId}/potty_tracker_data/{YYYY-MM}
            return doc(db, `artifacts/${appId}/users/${userId}/potty_tracker_data/${monthYearKey}`);
        }

        async function loadAppConfig() {
            const configRef = getUserConfigDocRef();
            if (!configRef) return;
            try {
                const configSnap = await getDoc(configRef);
                if (configSnap.exists()) {
                    appConfig = configSnap.data();
                }
                updateHeaderUI();
            } catch (error) {
                console.error("Ralat memuatkan konfigurasi aplikasi:", error);
            }
        }

        async function saveAppConfig() {
            const configRef = getUserConfigDocRef();
            if (!configRef) {
                showMessageModal("Ralat", "Gagal menyimpan: Pengguna tidak disahkan.");
                return;
            }
            try {
                await setDoc(configRef, appConfig);
                updateHeaderUI();
                showMessageModal("Berjaya", "Tetapan aplikasi telah disimpan!");
            } catch (error) {
                console.error("Ralat menyimpan konfigurasi aplikasi:", error);
                showMessageModal("Ralat Penyimpanan", "Gagal menyimpan tetapan ke pangkalan data.");
            }
        }

        // Memasang pendengar masa nyata untuk data bulanan semasa
        function setupMonthlyDataListener() {
            if (!isAuthReady || !userId) return;
            
            const dataRef = getMonthlyDataDocRef(currentMonthDate);
            
            // Hentikan pendengar sebelumnya jika ada
            if (window.monthlyUnsubscribe) {
                window.monthlyUnsubscribe();
            }

            // Memasang pendengar baru
            window.monthlyUnsubscribe = onSnapshot(dataRef, (docSnap) => {
                if (docSnap.exists()) {
                    trackerData = docSnap.data();
                } else {
                    trackerData = {}; // Tiada data untuk bulan ini
                }
                renderGrid();
                calculateStats();
                updateHeaderUI(); // Untuk kemas kini tarikh
            }, (error) => {
                console.error("Ralat pendengar data bulanan:", error);
                if (error.code !== "permission-denied") {
                    showMessageModal("Ralat Data", "Gagal menyambung ke data masa nyata.");
                }
            });
        }
        
        // Simpan/Kemaskini satu entri sel
        async function saveCellData(day, timeIndex, code) {
            if (!isAuthReady || !userId) {
                showMessageModal("Ralat", "Gagal menyimpan: Sila tunggu pengesahan.");
                return;
            }
            
            const key = `${day}_${timeIndex}`;
            const dataRef = getMonthlyDataDocRef(currentMonthDate);
            
            const updatePayload = {};
            if (code === null) {
                updatePayload[key] = deleteField(); 
            } else {
                updatePayload[key] = code;
            }
            
            try {
                await setDoc(dataRef, updatePayload, { merge: true });
            } catch (error) {
                console.error("Ralat menyimpan data sel:", error);
                showMessageModal("Ralat Penyimpanan", "Gagal menyimpan data ke pangkalan data.");
            }
        }

        // --------------------------------------------------------
        // UTILITY FUNCTIONS (Fungsi Bantuan)
        // --------------------------------------------------------

        // Memaparkan Modal Mesej Kustom
        function showMessageModal(title, message) {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function calculateDaysInMonth(date) {
            const nextMonth = new Date(date.getFullYear(), date.getMonth() + 1, 1);
            const lastDay = new Date(nextMonth - 1);
            return lastDay.getDate();
        }

        function formatDateRange(date) {
            const daysInMonth = calculateDaysInMonth(date);
            const monthNames = ["Januari", "Februari", "Mac", "April", "Mei", "Jun", "Julai", "Ogos", "September", "Oktober", "November", "Disember"];
            const monthName = monthNames[date.getMonth()];
            const year = date.getFullYear();

            document.getElementById('stats-month-year').textContent = `${monthName} ${year}`;
            return `Tarikh: 1hb ${monthName} ${year} - ${daysInMonth} ${monthName} ${year}`;
        }
        
        function updateHeaderUI() {
            document.getElementById('student-name-display').textContent = appConfig.studentName || "Pelajar";
            document.getElementById('school-location-display').textContent = appConfig.schoolLocation || "Lokasi Sekolah Tidak Ditetapkan";
            document.getElementById('current-month-display').textContent = formatDateRange(currentMonthDate);
        }
        
        // Mengira Peratusan Kejayaan
        function calculateStats() {
            let totalSuccess = 0; // Kod 2
            let totalAttempts = 0; // Kod 1 atau 2

            for (const key in trackerData) {
                const code = trackerData[key];
                if (code === 2) {
                    totalSuccess++;
                    totalAttempts++;
                } else if (code === 1) {
                    totalAttempts++;
                }
            }

            const successRate = totalAttempts > 0 ? (totalSuccess / totalAttempts) * 100 : 0;

            // Kemas kini UI Statistik
            const percentageText = `${Math.round(successRate)}%`;
            document.getElementById('success-percentage').textContent = percentageText;
            document.getElementById('progress-bar').style.width = percentageText;
            document.getElementById('total-success').textContent = totalSuccess;
            document.getElementById('total-attempts').textContent = totalAttempts;
        }
        
        // Memuat turun fail
        function downloadFile(filename, data) {
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }


        // --------------------------------------------------------
        // BUTTON FUNCTIONALITY IMPLEMENTATIONS
        // --------------------------------------------------------
        
        // Fungsi untuk Export Data ke JSON
        function exportDataToJson() {
            if (!isAuthReady) {
                showMessageModal("Ralat", "Sila tunggu sehingga pengesahan data selesai.");
                return;
            }
            
            const exportObject = {
                config: appConfig,
                trackerData: trackerData,
                month: currentMonthDate.getMonth() + 1,
                year: currentMonthDate.getFullYear(),
                appId: appId
            };

            const filename = `data_latihan_tandas_${appConfig.studentName.replace(/\s/g, '_')}_${currentMonthDate.getFullYear()}-${String(currentMonthDate.getMonth() + 1).padStart(2, '0')}.json`;
            
            try {
                const jsonString = JSON.stringify(exportObject, null, 2);
                downloadFile(filename, jsonString);
                showMessageModal("Export Berjaya", `Data bulan ${currentMonthDate.getMonth() + 1}/${currentMonthDate.getFullYear()} telah dimuat turun sebagai ${filename}.`);
            } catch (error) {
                console.error("Ralat semasa export data:", error);
                showMessageModal("Ralat Export", "Gagal menghasilkan fail JSON.");
            }
        }
        
        // Fungsi untuk Import Data dari JSON
        function importDataFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData.trackerData || typeof importedData.trackerData !== 'object') {
                        throw new Error("Struktur data tidak sah.");
                    }
                    
                    // Simpan data ke Firestore untuk bulan semasa
                    const dataRef = getMonthlyDataDocRef(currentMonthDate);
                    // Gunakan setDoc untuk menggantikan keseluruhan data bulan semasa
                    await setDoc(dataRef, importedData.trackerData);
                    
                    // Kemas kini konfigurasi jika ada
                    if (importedData.config) {
                        appConfig = importedData.config;
                        await saveAppConfig();
                    }
                    
                    showMessageModal("Import Berjaya", `Data dari fail "${file.name}" telah berjaya dimuat naik ke bulan semasa!`);

                } catch (error) {
                    console.error("Ralat semasa import data:", error);
                    showMessageModal("Ralat Import", `Gagal memproses fail: ${error.message}. Pastikan ia adalah fail JSON yang sah.`);
                } finally {
                    // Reset input file agar acara 'change' dicetuskan semula jika fail yang sama dipilih
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        // --------------------------------------------------------
        // RENDER FUNCTIONS (Fungsi Render)
        // --------------------------------------------------------

        // Mengendalikan klik sel grid - KINI MEMBUKA MODAL EDIT
        function handleCellClick(day, timeIndex, cellElement) {
            showEditModal(day, timeIndex, cellElement);
        }

        // Menunjukkan modal untuk mengedit/membuang data
        function showEditModal(day, timeIndex, cellElement) {
            const timeSlot = TIME_SLOTS[timeIndex];
            const modal = document.getElementById('edit-modal');
            const contextText = `Sila pilih kod atau buang data untuk Hari ${day}, Jam ${timeSlot}.`;
            document.getElementById('edit-modal-context').textContent = contextText;

            // Logik untuk menutup modal
            const closeModal = () => modal.classList.add('hidden');

            // FUNGSI UTAMA UNTUK KEMASKINI
            const updateAndClose = (code) => {
                saveCellData(day, timeIndex, code); // code=null untuk buang data
                closeModal();
            }

            // Tetapkan event listeners untuk butang kod (0, 1, 2)
            const codeButtons = modal.querySelectorAll('.code-btn');
            
            // Klon dan ganti butang untuk mengelakkan pendengar berganda
            codeButtons.forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                const code = parseInt(newButton.getAttribute('data-code'));
                newButton.addEventListener('click', () => updateAndClose(code));
            });

            // Tetapkan event listener untuk butang Buang Data
            const removeButton = document.getElementById('remove-data-btn');
            const newRemoveButton = removeButton.cloneNode(true);
            removeButton.parentNode.replaceChild(newRemoveButton, removeButton);
            newRemoveButton.addEventListener('click', () => updateAndClose(null)); // Kod null untuk buang
            
            // Tetapkan event listener untuk butang Batal
            const cancelButton = document.getElementById('cancel-edit-btn');
            const newCancelButton = cancelButton.cloneNode(true);
            cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);
            newCancelButton.addEventListener('click', closeModal);

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }


        // Mengemas kini visual sel
        function updateCellVisual(cellElement, code) {
            cellElement.className = 'grid-cell h-10 w-full rounded-md shadow-sm border border-gray-200 text-center';
            cellElement.innerHTML = '';
            
            if (code === 2) {
                cellElement.classList.add('code-2');
                cellElement.innerHTML = '<span>‚≠ê</span>';
            } else if (code === 1) {
                cellElement.classList.add('code-1');
                cellElement.innerHTML = '<span>ü§î</span>';
            } else if (code === 0) {
                cellElement.classList.add('code-0');
                cellElement.innerHTML = '<span>üíß</span>';
            } else {
                cellElement.classList.add('code-empty');
                cellElement.innerHTML = '';
            }
        }

        // Menghasilkan keseluruhan grid jadual
        function renderGrid() {
            const gridContainer = document.getElementById('data-grid');
            gridContainer.innerHTML = '';

            const daysInMonth = calculateDaysInMonth(currentMonthDate);
            const gridColumns = daysInMonth + 1; 
            
            gridContainer.style.display = 'grid';
            gridContainer.style.gridTemplateColumns = `120px repeat(${daysInMonth}, minmax(40px, 1fr))`;
            gridContainer.classList.add('gap-1', 'text-sm', 'font-semibold');


            // 1. Baris Hari (Header)
            const dayHeader = document.createElement('div');
            dayHeader.classList.add('contents');
            
            let emptyCell = document.createElement('div');
            emptyCell.textContent = 'Masa/Hari';
            emptyCell.classList.add('bg-[#272831]', 'text-white', 'p-2', 'rounded-tl-lg', 'sticky', 'left-0', 'z-10');
            dayHeader.appendChild(emptyCell);

            // Sel Hari (1 hingga akhir bulan)
            for (let day = 1; day <= daysInMonth; day++) {
                let dayCell = document.createElement('div');
                dayCell.textContent = day;
                
                dayCell.classList.add('text-center', 'bg-gray-300', 'p-2');
                
                if (day === daysInMonth) {
                    dayCell.classList.add('rounded-tr-lg');
                }
                dayHeader.appendChild(dayCell);
            }
            gridContainer.appendChild(dayHeader);


            // 2. Baris Data (Masa + Sel Data)
            TIME_SLOTS.forEach((time, timeIndex) => {
                const row = document.createElement('div');
                row.classList.add('contents');

                let timeCell = document.createElement('div');
                timeCell.textContent = time;
                timeCell.classList.add('bg-gray-200', 'p-1', 'text-right', 'pr-2', 'font-medium', 'sticky', 'left-0', 'z-10');
                row.appendChild(timeCell);

                // Sel Data (Bilangan Hari)
                for (let day = 1; day <= daysInMonth; day++) {
                    let dataCell = document.createElement('div');
                    const key = `${day}_${timeIndex}`;
                    const initialCode = trackerData[key];
                    
                    updateCellVisual(dataCell, initialCode);
                    
                    dataCell.addEventListener('click', () => {
                        handleCellClick(day, timeIndex, dataCell);
                    });

                    row.appendChild(dataCell);
                }
                gridContainer.appendChild(row);
            });
        }


        // --------------------------------------------------------
        // MODAL AND EVENT HANDLERS
        // --------------------------------------------------------

        function showSettingsModal() {
            document.getElementById('setting-student-name').value = appConfig.studentName;
            document.getElementById('setting-school-location').value = appConfig.schoolLocation;
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('settings-modal').classList.add('flex');
        }

        function handleSaveSettings() {
            appConfig.studentName = document.getElementById('setting-student-name').value.trim() || "Pelajar";
            appConfig.schoolLocation = document.getElementById('setting-school-location').value.trim() || "Lokasi Sekolah Tidak Ditetapkan";
            
            saveAppConfig();
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function handleMonthChange(direction) {
            const month = currentMonthDate.getMonth();
            const year = currentMonthDate.getFullYear();
            
            currentMonthDate = new Date(year, month + direction, 1);
            
            setupMonthlyDataListener();
        }

        function setupEventListeners() {
            // Butang Edit Tetapan
            document.getElementById('edit-settings-btn').addEventListener('click', showSettingsModal);
            document.getElementById('cancel-settings-btn').addEventListener('click', () => document.getElementById('settings-modal').classList.add('hidden'));
            document.getElementById('save-settings-btn').addEventListener('click', handleSaveSettings);

            // Butang Navigasi Bulan
            document.getElementById('prev-month-btn').addEventListener('click', () => handleMonthChange(-1));
            document.getElementById('next-month-btn').addEventListener('click', () => handleMonthChange(1));

            // Butang Batal Modal Edit
            document.getElementById('cancel-edit-btn').addEventListener('click', () => document.getElementById('edit-modal').classList.add('hidden'));

            // Import Data: Mencetuskan klik pada input fail tersembunyi
            document.getElementById('import-data-btn').addEventListener('click', () => {
                document.getElementById('import-file-input').click();
            });
            // Import Data: Mengendalikan fail yang dipilih
            document.getElementById('import-file-input').addEventListener('change', importDataFromJson);

            // Export Data
            document.getElementById('export-data-btn').addEventListener('click', exportDataToJson);

            // Print
            document.getElementById('print-btn').addEventListener('click', () => {
                window.print();
            });

            // Download PDF (Menggunakan Print dengan Arahan)
            document.getElementById('download-pdf-btn').addEventListener('click', () => {
                showMessageModal(
                    "Muat Turun PDF", 
                    "Sila tunggu dialog cetakan muncul. Pilih 'Simpan sebagai PDF' (Save as PDF) sebagai destinasi untuk memuat turun data anda."
                );
                // Beri sedikit masa untuk modal ditutup sebelum mencetuskan cetakan
                setTimeout(() => {
                    window.print();
                }, 500); 
            });

            // Set Semula Data BULAN SEMASA (Diaktifkan)
            document.getElementById('reset-data-btn').addEventListener('click', async () => {
                const monthYear = `${currentMonthDate.getMonth() + 1}/${currentMonthDate.getFullYear()}`;
                
                if (window.confirm(`ADAKAH ANDA PASTI mahu menetapkan semula SEMUA data untuk bulan ${monthYear}? Tindakan ini TIDAK BOLEH ditarik balik!`)) {
                    if (!isAuthReady || !userId) {
                        showMessageModal("Ralat", "Gagal menetapkan semula: Sila tunggu pengesahan.");
                        return;
                    }
                    try {
                        const dataRef = getMonthlyDataDocRef(currentMonthDate);
                        await setDoc(dataRef, {}); 
                        showMessageModal("Set Semula Berjaya", `Semua data untuk bulan ${monthYear} telah ditetapkan semula.`);
                    } catch (error) {
                         console.error("Ralat menetapkan semula data:", error);
                         showMessageModal("Ralat", "Gagal menetapkan semula data.");
                    }
                }
            });
        }


        // --------------------------------------------------------
        // INITIALIZATION (Permulaan Aplikasi)
        // --------------------------------------------------------

        async function initializeApp() {
            setupEventListeners();
            await initFirebase();
        }

        window.onload = initializeApp;

    </script>
    
    <!-- Pendaftaran Service Worker untuk PWA / Offline (Diminta oleh Pengguna) -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(function(reg) {
                console.log('Service Worker didaftarkan dengan skop: ', reg.scope);
            }).catch(function(error) {
                console.error('Pendaftaran Service Worker gagal: ', error);
            });
        }
    </script>
</body>
</html>
