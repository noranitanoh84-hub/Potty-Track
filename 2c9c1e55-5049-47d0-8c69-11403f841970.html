<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title></title>
	<meta name="generator" content="LibreOffice 24.8.1.2 (Linux)"/>
	<meta name="created" content="00:00:00"/>
	<meta name="changed" content="00:00:00"/>
	<style type="text/css">
		@page { size: 8.27in 11.69in; margin: 0.79in }
		p { line-height: 115%; margin-bottom: 0.1in; background: transparent }
		pre { background: transparent }
		pre.western { font-family: "Liberation Mono", monospace; font-size: 10pt }
		pre.cjk { font-family: "NSimSun", monospace; font-size: 10pt }
		pre.ctl { font-family: "Liberation Mono", monospace; font-size: 10pt }
	</style>
</head>
<body lang="en-US" link="#000080" vlink="#800000" dir="ltr"><pre class="western">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;ms&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Juara Tandas Amir - Pengesan Latihan&lt;/title&gt;
    &lt;!-- Muat turun Tailwind CSS --&gt;
    &lt;script src=&quot;https://cdn.tailwindcss.com&quot;&gt;&lt;/script&gt;
    &lt;!-- Muat turun fon Urbanist dari Google Fonts --&gt;
    &lt;link href=&quot;https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600;700;800&amp;display=swap&quot; rel=&quot;stylesheet&quot;&gt;
    &lt;style&gt;
        /* Tetapkan fon Urbanist dan latar belakang */
        body {
            font-family: 'Urbanist', sans-serif;
            background-color: #F5F5F6; /* Warna latar belakang lembut dari palet */
            color: #272831; /* Warna teks utama */
            padding: 1rem;
        }

        /* Warna Palet Disesuaikan */
        .color-primary-yellow { background-color: #FED415; }
        .color-success-green { background-color: #5FC756; }
        .color-attempt-orange { background-color: #FDA014; }
        .color-failure-red { background-color: #E14535; }
        .color-dark-text { color: #272831; }

        /* Gaya sel grid untuk keseronokan */
        .grid-cell {
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .grid-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Untuk grid: */
        .grid-cell.code-2 { background-color: #d1fae5; color: #5FC756; }
        .grid-cell.code-1 { background-color: #fff9e6; color: #FDA014; }
        .grid-cell.code-0 { background-color: #fee2e2; color: #E14535; }
        .grid-cell.code-empty { background-color: white; }

        /* Icon di dalam grid */
        .grid-cell.code-2 span, .grid-cell.code-1 span, .grid-cell.code-0 span {
            color: inherit; /* Warisi warna sel */
        }
        
        /* Gaya untuk cetakan: Sembunyikan semua elemen interaktif semasa mencetak */
        @media print {
            body {
                background-color: white !important;
                padding: 0;
            }
            /* Sembunyikan butang dan modal */
            #edit-settings-btn, .color-primary-yellow, .flex-wrap, #user-id-display, .hidden.flex, #edit-modal, #settings-modal, #message-modal {
                display: none !important;
            }
            /* Kekalkan grid kelihatan baik */
            #data-grid {
                overflow: visible !important;
                min-width: 100% !important;
            }
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;

    &lt;div class=&quot;max-w-7xl mx-auto&quot;&gt;
        &lt;!-- HEADER: Cerita Utama Aplikasi --&gt;
        &lt;header class=&quot;color-primary-yellow p-6 rounded-3xl shadow-lg mb-8 border-4 border-[#272831] relative&quot;&gt;
            &lt;h1 class=&quot;text-4xl md:text-5xl font-extrabold color-dark-text flex items-center&quot;&gt;
                &lt;span id=&quot;student-name-display&quot;&gt;AMIR&lt;/span&gt;: JUARA TANDAS! üèÜ
                &lt;!-- Butang Edit Tetapan --&gt;
                &lt;button id=&quot;edit-settings-btn&quot; class=&quot;ml-4 p-2 bg-white rounded-full shadow-md hover:bg-gray-100 transition&quot;&gt;
                    &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; class=&quot;h-5 w-5 color-dark-text&quot; viewBox=&quot;0 0 20 20&quot; fill=&quot;currentColor&quot;&gt;
                        &lt;path d=&quot;M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.637 5.637l-6.364 6.364V17h2.414l6.364-6.364-2.828-2.828z&quot; /&gt;
                    &lt;/svg&gt;
                &lt;/button&gt;
            &lt;/h1&gt;
            &lt;p class=&quot;text-xl mt-2 font-medium color-dark-text&quot;&gt;
                &lt;span id=&quot;school-location-display&quot;&gt;Lokasi Sekolah Pelatih Contoh&lt;/span&gt;
            &lt;/p&gt;
            &lt;!-- Kawalan Navigasi Bulan/Tarikh --&gt;
            &lt;div class=&quot;mt-4 flex items-center justify-between bg-white/70 p-2 rounded-xl&quot;&gt;
                &lt;button id=&quot;prev-month-btn&quot; class=&quot;p-2 bg-gray-300 rounded-lg hover:bg-gray-400 transition color-dark-text font-bold text-sm sm:text-base&quot;&gt;
                    &amp;lt; BULAN LEPAS
                &lt;/button&gt;
                &lt;p class=&quot;text-lg sm:text-xl font-extrabold color-dark-text&quot; id=&quot;current-month-display&quot;&gt;
                    Tarikh: 1hb November 2025 - 30 November 2025
                &lt;/p&gt;
                &lt;button id=&quot;next-month-btn&quot; class=&quot;p-2 bg-gray-300 rounded-lg hover:bg-gray-400 transition color-dark-text font-bold text-sm sm:text-base&quot;&gt;
                    BULAN DEPAN &amp;gt;
                &lt;/button&gt;
            &lt;/div&gt;
        &lt;/header&gt;

        &lt;!-- KAD UTAMA &amp; STATISTIK --&gt;
        &lt;div class=&quot;grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8&quot;&gt;
            &lt;!-- Kad Legenda / Kod --&gt;
            &lt;div class=&quot;lg:col-span-1 p-6 bg-white rounded-2xl shadow-xl border-t-8 border-b-8 border-gray-200&quot;&gt;
                &lt;h2 class=&quot;text-2xl font-bold mb-3 color-dark-text&quot;&gt;Kod Pengumpulan Data:&lt;/h2&gt;
                &lt;ul class=&quot;space-y-3 font-semibold text-lg&quot;&gt;
                    &lt;li class=&quot;flex items-center&quot;&gt;
                        &lt;span class=&quot;mr-3 text-2xl&quot; style=&quot;color:#5FC756;&quot;&gt;‚≠ê&lt;/span&gt;
                        &lt;span class=&quot;text-[#5FC756]&quot;&gt;2&lt;/span&gt; = Kencing/Berak di Tandas (Juara!)
                    &lt;/li&gt;
                    &lt;li class=&quot;flex items-center&quot;&gt;
                        &lt;span class=&quot;mr-3 text-2xl&quot; style=&quot;color:#FDA014;&quot;&gt;ü§î&lt;/span&gt;
                        &lt;span class=&quot;text-[#FDA014]&quot;&gt;1&lt;/span&gt; = Pergi Tandas Tapi Tidak Berjaya (Cuba Lagi!)
                    &lt;/li&gt;
                    &lt;li class=&quot;flex items-center&quot;&gt;
                        &lt;span class=&quot;mr-3 text-2xl&quot; style=&quot;color:#E14535;&quot;&gt;üíß&lt;/span&gt;
                        &lt;span class=&quot;text-[#E14535]&quot;&gt;0&lt;/span&gt; = Kencing/Berak di Luar (Terlupa)
                    &lt;/li&gt;
                &lt;/ul&gt;
                &lt;p class=&quot;mt-4 text-sm text-gray-500&quot;&gt;
                    &lt;span id=&quot;user-id-display&quot; class=&quot;font-mono text-xs break-all&quot;&gt;&lt;/span&gt;
                &lt;/p&gt;
            &lt;/div&gt;

            &lt;!-- Kad Peratusan Kejayaan --&gt;
            &lt;div class=&quot;lg:col-span-3 p-6 bg-white rounded-2xl shadow-xl border-t-8 border-b-8 border-gray-200&quot;&gt;
                &lt;h2 class=&quot;text-2xl font-bold mb-3 color-dark-text&quot;&gt;Statistik Kejayaan (&lt;span id=&quot;stats-month-year&quot;&gt;&lt;/span&gt;):&lt;/h2&gt;
                &lt;div class=&quot;flex items-center space-x-4&quot;&gt;
                    &lt;div class=&quot;text-6xl font-extrabold&quot; id=&quot;success-percentage&quot;&gt;0%&lt;/div&gt;
                    &lt;div class=&quot;flex-1&quot;&gt;
                        &lt;p class=&quot;text-xl font-semibold mb-2&quot;&gt;Peratus kencing di tandas (%)&lt;/p&gt;
                        &lt;div class=&quot;w-full bg-[#EFEFF0] rounded-full h-4&quot;&gt;
                            &lt;div id=&quot;progress-bar&quot; class=&quot;h-4 rounded-full color-success-green transition-all duration-500&quot; style=&quot;width: 0%&quot;&gt;&lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;p class=&quot;mt-4 text-sm text-gray-500&quot;&gt;Jumlah Kejayaan: &lt;span id=&quot;total-success&quot; class=&quot;font-bold&quot;&gt;0&lt;/span&gt; / &lt;span id=&quot;total-attempts&quot; class=&quot;font-bold&quot;&gt;0&lt;/span&gt;&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;!-- GRID UTAMA PENGUMPULAN DATA --&gt;
        &lt;div class=&quot;bg-white p-4 rounded-2xl shadow-xl overflow-x-auto&quot;&gt;
            &lt;h2 class=&quot;text-2xl font-bold mb-4 color-dark-text&quot;&gt;Jadual Pengesanan:&lt;/h2&gt;
            &lt;div id=&quot;data-grid&quot; class=&quot;min-w-full&quot;&gt;
                &lt;!-- Grid akan dihasilkan oleh JavaScript di sini --&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;!-- BAHAGIAN BUTANG TINDAKAN --&gt;
        &lt;div class=&quot;flex flex-wrap justify-center space-x-4 mt-8&quot;&gt;
            &lt;!-- Input fail tersembunyi untuk Import Data --&gt;
            &lt;input type=&quot;file&quot; id=&quot;import-file-input&quot; class=&quot;hidden&quot; accept=&quot;application/json&quot;&gt; 
            
            &lt;button id=&quot;import-data-btn&quot; class=&quot;p-3 my-2 font-bold rounded-full bg-gray-300 hover:bg-gray-400 transition color-dark-text&quot;&gt;IMPORT DATA&lt;/button&gt;
            &lt;button id=&quot;export-data-btn&quot; class=&quot;p-3 my-2 font-bold rounded-full bg-gray-300 hover:bg-gray-400 transition color-dark-text&quot;&gt;EXPORT DATA&lt;/button&gt;
            &lt;button id=&quot;print-btn&quot; class=&quot;p-3 my-2 font-bold rounded-full bg-gray-300 hover:bg-gray-400 transition color-dark-text&quot;&gt;PRINT&lt;/button&gt;
            &lt;button id=&quot;download-pdf-btn&quot; class=&quot;p-3 my-2 font-bold rounded-full color-attempt-orange hover:bg-[#ffb028] transition color-dark-text&quot;&gt;DOWNLOAD (PDF)&lt;/button&gt;
            &lt;button id=&quot;reset-data-btn&quot; class=&quot;p-3 my-2 font-bold rounded-full bg-red-500 hover:bg-red-600 transition text-white&quot;&gt;SET SEMULA DATA BULAN INI&lt;/button&gt;
        &lt;/div&gt;
        &lt;p class=&quot;text-sm text-center text-gray-500 mt-4&quot;&gt;Nota: Data disimpan secara automatik dalam Firestore. Gunakan import/export untuk sandaran.&lt;/p&gt;
    &lt;/div&gt;

    &lt;!-- MODAL POPUP (Mesej Status Ringkas) --&gt;
    &lt;div id=&quot;message-modal&quot; class=&quot;fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50&quot;&gt;
        &lt;div class=&quot;bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center&quot;&gt;
            &lt;h3 id=&quot;modal-title&quot; class=&quot;text-2xl font-bold mb-4 color-dark-text&quot;&gt;&lt;/h3&gt;
            &lt;p id=&quot;modal-message&quot; class=&quot;mb-6&quot;&gt;&lt;/p&gt;
            &lt;button onclick=&quot;document.getElementById('message-modal').classList.add('hidden');&quot; class=&quot;p-2 w-full font-bold rounded-lg color-primary-yellow hover:opacity-80 color-dark-text&quot;&gt;OK&lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;!-- MODAL EDIT DATA (Pengumpulan Data) --&gt;
    &lt;div id=&quot;edit-modal&quot; class=&quot;fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50&quot;&gt;
        &lt;div class=&quot;bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center border-t-8 color-primary-yellow&quot;&gt;
            &lt;h3 class=&quot;text-2xl font-bold mb-2 color-dark-text&quot;&gt;Kemaskini Data&lt;/h3&gt;
            &lt;p id=&quot;edit-modal-context&quot; class=&quot;mb-4 text-sm text-gray-600&quot;&gt;&lt;/p&gt;
            
            &lt;div class=&quot;space-y-3 mb-6&quot;&gt;
                &lt;!-- Pilihan Kod 2 (Juara!) --&gt;
                &lt;button data-code=&quot;2&quot; class=&quot;code-btn w-full p-3 font-bold rounded-lg bg-green-500 hover:bg-green-600 transition text-white flex items-center justify-center&quot;&gt;
                    &lt;span class=&quot;mr-3 text-2xl&quot;&gt;‚≠ê&lt;/span&gt; Kod 2 (Juara!)
                &lt;/button&gt;
                
                &lt;!-- Pilihan Kod 1 (Cuba Lagi!) --&gt;
                &lt;button data-code=&quot;1&quot; class=&quot;code-btn w-full p-3 font-bold rounded-lg bg-yellow-500 hover:bg-yellow-600 transition text-white flex items-center justify-center&quot;&gt;
                    &lt;span class=&quot;mr-3 text-2xl&quot;&gt;ü§î&lt;/span&gt; Kod 1 (Cuba Lagi!)
                &lt;/button&gt;
                
                &lt;!-- Pilihan Kod 0 (Terlupa) --&gt;
                &lt;button data-code=&quot;0&quot; class=&quot;code-btn w-full p-3 font-bold rounded-lg bg-red-500 hover:bg-red-600 transition text-white flex items-center justify-center&quot;&gt;
                    &lt;span class=&quot;mr-3 text-2xl&quot;&gt;üíß&lt;/span&gt; Kod 0 (Terlupa)
                &lt;/button&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;flex space-x-3&quot;&gt;
                &lt;button id=&quot;remove-data-btn&quot; class=&quot;flex-1 p-2 font-bold rounded-lg bg-gray-400 hover:bg-gray-500 transition text-white&quot;&gt;
                    BUANG DATA
                &lt;/button&gt;
                &lt;button id=&quot;cancel-edit-btn&quot; class=&quot;flex-1 p-2 font-bold rounded-lg bg-gray-200 hover:bg-gray-300 transition color-dark-text&quot;&gt;
                    BATAL
                &lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- MODAL TETAPAN (Nama dan Lokasi Sekolah) --&gt;
    &lt;div id=&quot;settings-modal&quot; class=&quot;fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50&quot;&gt;
        &lt;div class=&quot;bg-white p-8 rounded-xl shadow-2xl max-w-md w-full border-t-8 border-blue-500&quot;&gt;
            &lt;h3 class=&quot;text-2xl font-bold mb-6 color-dark-text&quot;&gt;Tetapan Aplikasi&lt;/h3&gt;
            &lt;div class=&quot;space-y-4&quot;&gt;
                &lt;div&gt;
                    &lt;label for=&quot;setting-student-name&quot; class=&quot;block text-sm font-medium text-gray-700 mb-1&quot;&gt;Nama Pelajar:&lt;/label&gt;
                    &lt;input type=&quot;text&quot; id=&quot;setting-student-name&quot; class=&quot;w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500&quot; placeholder=&quot;Contoh: AMIR&quot;&gt;
                &lt;/div&gt;
                &lt;div&gt;
                    &lt;label for=&quot;setting-school-location&quot; class=&quot;block text-sm font-medium text-gray-700 mb-1&quot;&gt;Lokasi Sekolah Pelatih:&lt;/label&gt;
                    &lt;input type=&quot;text&quot; id=&quot;setting-school-location&quot; class=&quot;w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500&quot; placeholder=&quot;Contoh: SK Taman Indah&quot;&gt;
                &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;mt-6 flex justify-end space-x-3&quot;&gt;
                &lt;button id=&quot;cancel-settings-btn&quot; class=&quot;p-3 font-bold rounded-lg bg-gray-200 hover:bg-gray-300 transition color-dark-text&quot;&gt;
                    BATAL
                &lt;/button&gt;
                &lt;button id=&quot;save-settings-btn&quot; class=&quot;p-3 font-bold rounded-lg bg-blue-500 hover:bg-blue-600 transition text-white&quot;&gt;
                    SIMPAN
                &lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;


    &lt;script type=&quot;module&quot;&gt;
        // Import Firebase SDKs. Pastikan semua yang diperlukan diimport di sini.
        import { initializeApp as fbInitializeApp } from &quot;https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js&quot;; 
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from &quot;https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js&quot;;
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel, deleteField } from &quot;https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js&quot;;
        
        // Tetapan Global Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Data Global
        const TIME_SLOTS = [
            '1:00 AM', '2:00 AM', '3:00 AM', '4:00 AM', '5:00 AM', '6:00 AM', 
            '7:00 AM', '8:00 AM', '9:00 AM', '10:00 AM', '11:00 AM', '12:00 PM'
        ];
        
        // Firebase Instances
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Data Aplikasi
        let trackerData = {}; // Data pengesan semasa (bulan ini)
        let appConfig = {
            studentName: &quot;AMIR&quot;,
            schoolLocation: &quot;Lokasi Sekolah Pelatih Contoh&quot;
        };
        let currentMonthDate = new Date(); // Objek tarikh untuk menjejaki bulan/tahun semasa

        // --------------------------------------------------------
        // FIREBASE &amp; AUTHENTICATION
        // --------------------------------------------------------

        async function initFirebase() {
            try {
                // setLogLevel('debug'); // Buka komen untuk debugging
                app = fbInitializeApp(firebaseConfig); 
                db = getFirestore(app);
                auth = getAuth(app);

                // Autentikasi pengguna
                onAuthStateChanged(auth, (user) =&gt; {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id-display').textContent = `User ID (Simpanan Data): ${userId}`;
                        loadAppConfig();
                        setupMonthlyDataListener();
                    } else {
                        if (initialAuthToken) {
                            console.warn(&quot;Autentikasi token custom gagal, mencuba secara anonim...&quot;);
                        }
                        signInAnonymously(auth).then(() =&gt; {
                        }).catch((error) =&gt; {
                             console.error(&quot;Gagal log masuk secara anonim:&quot;, error);
                             userId = null;
                             isAuthReady = true;
                             document.getElementById('user-id-display').textContent = `Gagal log masuk.`;
                             showMessageModal(&quot;Ralat Log Masuk&quot;, &quot;Gagal log masuk. Sila cuba lagi.&quot;);
                        });
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(error =&gt; {
                        console.warn(&quot;signInWithCustomToken gagal:&quot;, error);
                    });
                }
                
            } catch (error) {
                console.error(&quot;Ralat permulaan Firebase:&quot;, error);
                showMessageModal(&quot;Ralat Firebase&quot;, &quot;Gagal memulakan perkhidmatan Firebase. Semak konsol untuk butiran.&quot;);
            }
        }

        // --------------------------------------------------------
        // DATA PATHS &amp; FIREBASE OPERATIONS
        // --------------------------------------------------------

        function getUserConfigDocRef() {
            if (!userId) return null;
            // Path: /artifacts/{appId}/users/{userId}/settings/config
            return doc(db, `artifacts/${appId}/users/${userId}/settings/config`);
        }
        
        function getMonthlyDataDocRef(date) {
            if (!userId) return null;
            // Format YYYY-MM
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const monthYearKey = `${year}-${month}`;
            // Path: /artifacts/{appId}/users/{userId}/potty_tracker_data/{YYYY-MM}
            return doc(db, `artifacts/${appId}/users/${userId}/potty_tracker_data/${monthYearKey}`);
        }

        async function loadAppConfig() {
            const configRef = getUserConfigDocRef();
            if (!configRef) return;
            try {
                const configSnap = await getDoc(configRef);
                if (configSnap.exists()) {
                    appConfig = configSnap.data();
                }
                updateHeaderUI();
            } catch (error) {
                console.error(&quot;Ralat memuatkan konfigurasi aplikasi:&quot;, error);
            }
        }

        async function saveAppConfig() {
            const configRef = getUserConfigDocRef();
            if (!configRef) {
                showMessageModal(&quot;Ralat&quot;, &quot;Gagal menyimpan: Pengguna tidak disahkan.&quot;);
                return;
            }
            try {
                await setDoc(configRef, appConfig);
                updateHeaderUI();
                showMessageModal(&quot;Berjaya&quot;, &quot;Tetapan aplikasi telah disimpan!&quot;);
            } catch (error) {
                console.error(&quot;Ralat menyimpan konfigurasi aplikasi:&quot;, error);
                showMessageModal(&quot;Ralat Penyimpanan&quot;, &quot;Gagal menyimpan tetapan ke pangkalan data.&quot;);
            }
        }

        // Memasang pendengar masa nyata untuk data bulanan semasa
        function setupMonthlyDataListener() {
            if (!isAuthReady || !userId) return;
            
            const dataRef = getMonthlyDataDocRef(currentMonthDate);
            
            // Hentikan pendengar sebelumnya jika ada
            if (window.monthlyUnsubscribe) {
                window.monthlyUnsubscribe();
            }

            // Memasang pendengar baru
            window.monthlyUnsubscribe = onSnapshot(dataRef, (docSnap) =&gt; {
                if (docSnap.exists()) {
                    trackerData = docSnap.data();
                } else {
                    trackerData = {}; // Tiada data untuk bulan ini
                }
                renderGrid();
                calculateStats();
                updateHeaderUI(); // Untuk kemas kini tarikh
            }, (error) =&gt; {
                console.error(&quot;Ralat pendengar data bulanan:&quot;, error);
                if (error.code !== &quot;permission-denied&quot;) {
                    showMessageModal(&quot;Ralat Data&quot;, &quot;Gagal menyambung ke data masa nyata.&quot;);
                }
            });
        }
        
        // Simpan/Kemaskini satu entri sel
        async function saveCellData(day, timeIndex, code) {
            if (!isAuthReady || !userId) {
                showMessageModal(&quot;Ralat&quot;, &quot;Gagal menyimpan: Sila tunggu pengesahan.&quot;);
                return;
            }
            
            const key = `${day}_${timeIndex}`;
            const dataRef = getMonthlyDataDocRef(currentMonthDate);
            
            const updatePayload = {};
            if (code === null) {
                updatePayload[key] = deleteField(); 
            } else {
                updatePayload[key] = code;
            }
            
            try {
                await setDoc(dataRef, updatePayload, { merge: true });
            } catch (error) {
                console.error(&quot;Ralat menyimpan data sel:&quot;, error);
                showMessageModal(&quot;Ralat Penyimpanan&quot;, &quot;Gagal menyimpan data ke pangkalan data.&quot;);
            }
        }

        // --------------------------------------------------------
        // UTILITY FUNCTIONS (Fungsi Bantuan)
        // --------------------------------------------------------

        // Memaparkan Modal Mesej Kustom
        function showMessageModal(title, message) {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function calculateDaysInMonth(date) {
            const nextMonth = new Date(date.getFullYear(), date.getMonth() + 1, 1);
            const lastDay = new Date(nextMonth - 1);
            return lastDay.getDate();
        }

        function formatDateRange(date) {
            const daysInMonth = calculateDaysInMonth(date);
            const monthNames = [&quot;Januari&quot;, &quot;Februari&quot;, &quot;Mac&quot;, &quot;April&quot;, &quot;Mei&quot;, &quot;Jun&quot;, &quot;Julai&quot;, &quot;Ogos&quot;, &quot;September&quot;, &quot;Oktober&quot;, &quot;November&quot;, &quot;Disember&quot;];
            const monthName = monthNames[date.getMonth()];
            const year = date.getFullYear();

            document.getElementById('stats-month-year').textContent = `${monthName} ${year}`;
            return `Tarikh: 1hb ${monthName} ${year} - ${daysInMonth} ${monthName} ${year}`;
        }
        
        function updateHeaderUI() {
            document.getElementById('student-name-display').textContent = appConfig.studentName || &quot;Pelajar&quot;;
            document.getElementById('school-location-display').textContent = appConfig.schoolLocation || &quot;Lokasi Sekolah Tidak Ditetapkan&quot;;
            document.getElementById('current-month-display').textContent = formatDateRange(currentMonthDate);
        }
        
        // Mengira Peratusan Kejayaan
        function calculateStats() {
            let totalSuccess = 0; // Kod 2
            let totalAttempts = 0; // Kod 1 atau 2

            for (const key in trackerData) {
                const code = trackerData[key];
                if (code === 2) {
                    totalSuccess++;
                    totalAttempts++;
                } else if (code === 1) {
                    totalAttempts++;
                }
            }

            const successRate = totalAttempts &gt; 0 ? (totalSuccess / totalAttempts) * 100 : 0;

            // Kemas kini UI Statistik
            const percentageText = `${Math.round(successRate)}%`;
            document.getElementById('success-percentage').textContent = percentageText;
            document.getElementById('progress-bar').style.width = percentageText;
            document.getElementById('total-success').textContent = totalSuccess;
            document.getElementById('total-attempts').textContent = totalAttempts;
        }
        
        // Memuat turun fail
        function downloadFile(filename, data) {
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }


        // --------------------------------------------------------
        // BUTTON FUNCTIONALITY IMPLEMENTATIONS
        // --------------------------------------------------------
        
        // Fungsi untuk Export Data ke JSON
        function exportDataToJson() {
            if (!isAuthReady) {
                showMessageModal(&quot;Ralat&quot;, &quot;Sila tunggu sehingga pengesahan data selesai.&quot;);
                return;
            }
            
            const exportObject = {
                config: appConfig,
                trackerData: trackerData,
                month: currentMonthDate.getMonth() + 1,
                year: currentMonthDate.getFullYear(),
                appId: appId
            };

            const filename = `data_latihan_tandas_${appConfig.studentName.replace(/\s/g, '_')}_${currentMonthDate.getFullYear()}-${String(currentMonthDate.getMonth() + 1).padStart(2, '0')}.json`;
            
            try {
                const jsonString = JSON.stringify(exportObject, null, 2);
                downloadFile(filename, jsonString);
                showMessageModal(&quot;Export Berjaya&quot;, `Data bulan ${currentMonthDate.getMonth() + 1}/${currentMonthDate.getFullYear()} telah dimuat turun sebagai ${filename}.`);
            } catch (error) {
                console.error(&quot;Ralat semasa export data:&quot;, error);
                showMessageModal(&quot;Ralat Export&quot;, &quot;Gagal menghasilkan fail JSON.&quot;);
            }
        }
        
        // Fungsi untuk Import Data dari JSON
        function importDataFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) =&gt; {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData.trackerData || typeof importedData.trackerData !== 'object') {
                        throw new Error(&quot;Struktur data tidak sah.&quot;);
                    }
                    
                    // Simpan data ke Firestore untuk bulan semasa
                    const dataRef = getMonthlyDataDocRef(currentMonthDate);
                    // Gunakan setDoc untuk menggantikan keseluruhan data bulan semasa
                    await setDoc(dataRef, importedData.trackerData);
                    
                    // Kemas kini konfigurasi jika ada
                    if (importedData.config) {
                        appConfig = importedData.config;
                        await saveAppConfig();
                    }
                    
                    showMessageModal(&quot;Import Berjaya&quot;, `Data dari fail &quot;${file.name}&quot; telah berjaya dimuat naik ke bulan semasa!`);

                } catch (error) {
                    console.error(&quot;Ralat semasa import data:&quot;, error);
                    showMessageModal(&quot;Ralat Import&quot;, `Gagal memproses fail: ${error.message}. Pastikan ia adalah fail JSON yang sah.`);
                }
            };
            reader.readAsText(file);
        }

        // --------------------------------------------------------
        // RENDER FUNCTIONS (Fungsi Render)
        // --------------------------------------------------------

        // Mengendalikan klik sel grid - KINI MEMBUKA MODAL EDIT
        function handleCellClick(day, timeIndex, cellElement) {
            showEditModal(day, timeIndex, cellElement);
        }

        // Menunjukkan modal untuk mengedit/membuang data
        function showEditModal(day, timeIndex, cellElement) {
            const timeSlot = TIME_SLOTS[timeIndex];
            const modal = document.getElementById('edit-modal');
            const contextText = `Sila pilih kod atau buang data untuk Hari ${day}, Jam ${timeSlot}.`;
            document.getElementById('edit-modal-context').textContent = contextText;

            // Logik untuk menutup modal
            const closeModal = () =&gt; modal.classList.add('hidden');

            // FUNGSI UTAMA UNTUK KEMASKINI
            const updateAndClose = (code) =&gt; {
                saveCellData(day, timeIndex, code); // code=null untuk buang data
                closeModal();
            }

            // Tetapkan event listeners untuk butang kod (0, 1, 2)
            const codeButtons = modal.querySelectorAll('.code-btn');
            
            codeButtons.forEach(button =&gt; {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                const code = parseInt(newButton.getAttribute('data-code'));
                newButton.addEventListener('click', () =&gt; updateAndClose(code));
            });

            // Tetapkan event listener untuk butang Buang Data
            const removeButton = document.getElementById('remove-data-btn');
            const newRemoveButton = removeButton.cloneNode(true);
            removeButton.parentNode.replaceChild(newRemoveButton, removeButton);
            newRemoveButton.addEventListener('click', () =&gt; updateAndClose(null)); // Kod null untuk buang
            
            // Tetapkan event listener untuk butang Batal
            const cancelButton = document.getElementById('cancel-edit-btn');
            const newCancelButton = cancelButton.cloneNode(true);
            cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);
            newCancelButton.addEventListener('click', closeModal);

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }


        // Mengemas kini visual sel
        function updateCellVisual(cellElement, code) {
            cellElement.className = 'grid-cell h-10 w-full rounded-md shadow-sm border border-gray-200 text-center';
            cellElement.innerHTML = '';
            
            if (code === 2) {
                cellElement.classList.add('code-2');
                cellElement.innerHTML = '&lt;span&gt;‚≠ê&lt;/span&gt;';
            } else if (code === 1) {
                cellElement.classList.add('code-1');
                cellElement.innerHTML = '&lt;span&gt;ü§î&lt;/span&gt;';
            } else if (code === 0) {
                cellElement.classList.add('code-0');
                cellElement.innerHTML = '&lt;span&gt;üíß&lt;/span&gt;';
            } else {
                cellElement.classList.add('code-empty');
                cellElement.innerHTML = '';
            }
        }

        // Menghasilkan keseluruhan grid jadual
        function renderGrid() {
            const gridContainer = document.getElementById('data-grid');
            gridContainer.innerHTML = '';

            const daysInMonth = calculateDaysInMonth(currentMonthDate);
            const gridColumns = daysInMonth + 1; 
            
            gridContainer.style.display = 'grid';
            gridContainer.style.gridTemplateColumns = `120px repeat(${daysInMonth}, minmax(40px, 1fr))`;
            gridContainer.classList.add('gap-1', 'text-sm', 'font-semibold');


            // 1. Baris Hari (Header)
            const dayHeader = document.createElement('div');
            dayHeader.classList.add('contents');
            
            let emptyCell = document.createElement('div');
            emptyCell.textContent = 'Masa/Hari';
            emptyCell.classList.add('bg-[#272831]', 'text-white', 'p-2', 'rounded-tl-lg', 'sticky', 'left-0', 'z-10');
            dayHeader.appendChild(emptyCell);

            // Sel Hari (1 hingga akhir bulan)
            for (let day = 1; day &lt;= daysInMonth; day++) {
                let dayCell = document.createElement('div');
                dayCell.textContent = day;
                
                dayCell.classList.add('text-center', 'bg-gray-300', 'p-2');
                
                if (day === daysInMonth) {
                    dayCell.classList.add('rounded-tr-lg');
                }
                dayHeader.appendChild(dayCell);
            }
            gridContainer.appendChild(dayHeader);


            // 2. Baris Data (Masa + Sel Data)
            TIME_SLOTS.forEach((time, timeIndex) =&gt; {
                const row = document.createElement('div');
                row.classList.add('contents');

                let timeCell = document.createElement('div');
                timeCell.textContent = time;
                timeCell.classList.add('bg-gray-200', 'p-1', 'text-right', 'pr-2', 'font-medium', 'sticky', 'left-0', 'z-10');
                row.appendChild(timeCell);

                // Sel Data (Bilangan Hari)
                for (let day = 1; day &lt;= daysInMonth; day++) {
                    let dataCell = document.createElement('div');
                    const key = `${day}_${timeIndex}`;
                    const initialCode = trackerData[key];
                    
                    updateCellVisual(dataCell, initialCode);
                    
                    dataCell.addEventListener('click', () =&gt; {
                        handleCellClick(day, timeIndex, dataCell);
                    });

                    row.appendChild(dataCell);
                }
                gridContainer.appendChild(row);
            });
        }


        // --------------------------------------------------------
        // MODAL AND EVENT HANDLERS
        // --------------------------------------------------------

        function showSettingsModal() {
            document.getElementById('setting-student-name').value = appConfig.studentName;
            document.getElementById('setting-school-location').value = appConfig.schoolLocation;
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('settings-modal').classList.add('flex');
        }

        function handleSaveSettings() {
            appConfig.studentName = document.getElementById('setting-student-name').value.trim() || &quot;Pelajar&quot;;
            appConfig.schoolLocation = document.getElementById('setting-school-location').value.trim() || &quot;Lokasi Sekolah Tidak Ditetapkan&quot;;
            
            saveAppConfig();
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function handleMonthChange(direction) {
            const month = currentMonthDate.getMonth();
            const year = currentMonthDate.getFullYear();
            
            currentMonthDate = new Date(year, month + direction, 1);
            
            setupMonthlyDataListener();
        }

        function setupEventListeners() {
            // Butang Edit Tetapan
            document.getElementById('edit-settings-btn').addEventListener('click', showSettingsModal);
            document.getElementById('cancel-settings-btn').addEventListener('click', () =&gt; document.getElementById('settings-modal').classList.add('hidden'));
            document.getElementById('save-settings-btn').addEventListener('click', handleSaveSettings);

            // Butang Navigasi Bulan
            document.getElementById('prev-month-btn').addEventListener('click', () =&gt; handleMonthChange(-1));
            document.getElementById('next-month-btn').addEventListener('click', () =&gt; handleMonthChange(1));

            // Butang Batal Modal Edit
            document.getElementById('cancel-edit-btn').addEventListener('click', () =&gt; document.getElementById('edit-modal').classList.add('hidden'));

            // Import Data: Mencetuskan klik pada input fail tersembunyi
            document.getElementById('import-data-btn').addEventListener('click', () =&gt; {
                document.getElementById('import-file-input').click();
            });
            // Import Data: Mengendalikan fail yang dipilih
            document.getElementById('import-file-input').addEventListener('change', importDataFromJson);

            // Export Data
            document.getElementById('export-data-btn').addEventListener('click', exportDataToJson);

            // Print
            document.getElementById('print-btn').addEventListener('click', () =&gt; {
                window.print();
            });

            // Download PDF (Menggunakan Print dengan Arahan)
            document.getElementById('download-pdf-btn').addEventListener('click', () =&gt; {
                showMessageModal(
                    &quot;Muat Turun PDF&quot;, 
                    &quot;Sila tunggu dialog cetakan muncul. Pilih 'Simpan sebagai PDF' (Save as PDF) sebagai destinasi untuk memuat turun data anda.&quot;
                );
                // Beri sedikit masa untuk modal ditutup sebelum mencetuskan cetakan
                setTimeout(() =&gt; {
                    window.print();
                }, 500); 
            });

            // Set Semula Data BULAN SEMASA (Diaktifkan)
            document.getElementById('reset-data-btn').addEventListener('click', async () =&gt; {
                const monthYear = `${currentMonthDate.getMonth() + 1}/${currentMonthDate.getFullYear()}`;
                
                if (window.confirm(`ADAKAH ANDA PASTI mahu menetapkan semula SEMUA data untuk bulan ${monthYear}? Tindakan ini TIDAK BOLEH ditarik balik!`)) {
                    if (!isAuthReady || !userId) {
                        showMessageModal(&quot;Ralat&quot;, &quot;Gagal menetapkan semula: Sila tunggu pengesahan.&quot;);
                        return;
                    }
                    try {
                        const dataRef = getMonthlyDataDocRef(currentMonthDate);
                        await setDoc(dataRef, {}); 
                        showMessageModal(&quot;Set Semula Berjaya&quot;, `Semua data untuk bulan ${monthYear} telah ditetapkan semula.`);
                    } catch (error) {
                         console.error(&quot;Ralat menetapkan semula data:&quot;, error);
                         showMessageModal(&quot;Ralat&quot;, &quot;Gagal menetapkan semula data.&quot;);
                    }
                }
            });
        }


        // --------------------------------------------------------
        // INITIALIZATION (Permulaan Aplikasi)
        // --------------------------------------------------------

        async function initializeApp() {
            setupEventListeners();
            await initFirebase();
        }

        window.onload = initializeApp;

    &lt;/script&gt;
    
    &lt;!-- Pendaftaran Service Worker untuk PWA / Offline (Diminta oleh Pengguna) --&gt;
    &lt;script&gt;
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(function(reg) {
                console.log('Service Worker didaftarkan dengan skop: ', reg.scope);
            }).catch(function(error) {
                console.error('Pendaftaran Service Worker gagal: ', error);
            });
        }
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</body>
</html>